(function(a){tinyMCE.create("tinymce.plugins.Kitchenbug",{init:function(b,c){var d=this;d.url=c;d._createkbButtons();b.onKeyUp.add(function(h,g){if(g.keyCode==46){b.plugins.wordpress._hideButtons();var f=tinymce.DOM;f.hide(f.select("#kb_recipebtns"));kBugObject.recipeIds=null;kBugObject.isUpdating=false}});b.onChange.add(function(j,h){var g=tinymce.activeEditor.contentDocument.getElementsByTagName("img");for(var f=0;f<g.length;f++){g[f].className=g[f].className}});b.addCommand("openkitchenbugeditor",function(){jQuery("#kb_form3").text("edit");d.toggleDisplay();a(window).trigger("kitchenbugopen")});b.addCommand("openkitchenbugAddNew",function(){jQuery("#kb_form3").text("add new");d.toggleDisplay();a(window).trigger("kitchenbugopen")});b.onLoadContent.add(function(g,f){if(g.editorId!="mce_fullscreen"){a(window).trigger("kitchenbugload",[g,f])}});b.onGetContent.add(function(e,f){if(jQuery("#kb_container").parent().is(":visible")){return}if((-1==f.content.indexOf('data-mce-bogus="1"'))&&(-1==f.content.indexOf("[kitchenbug-your-recipe-appears-here-"))&&(-1==f.content.indexOf("kitchenbugRecipe"))){setInputAttrOrValue("FLUSH");return}setInputAttrOrValue("IMPORT")});b.onSetContent.add(function(g,f){if(g.editorId=="mce_fullscreen"&&!f.initial){a(window).trigger("kitchenbugload",[g,f])}});b.onBeforeSetContent.add(function(e,f){f.content=d._do_kbinsertion(f.content,d.url)});b.onPostProcess.add(function(e,f){if(f.get){f.content=d._do_postkbinsert(f.content)}});b.addButton("kbugRecipe",{title:"Kitchenbug - Click to add or edit a recipe",image:d.url+"/../img/icon_kb-logo_settings.png",onclick:function(e){jQuery("#kb_container").css({display:"block"});if(kBugObject.recipeIds==null||kBugObject.recipeIds==""){jQuery("#kb_form3").text("add new")}else{jQuery("#kb_form3").text("edit")}d.toggleDisplay();a(window).trigger("kitchenbugopen")}});b.onMouseDown.add(function(f,h){if(h.target.nodeName=="IMG"&&b.dom.hasClass(h.target,"kitchenbugRecipe")){b.plugins.wordpress._hideButtons();b.plugins.wordpress._showButtons(h.target,"kb_recipebtns")}else{var g=tinymce.DOM;g.hide(g.select("#kb_recipebtns"))}})},_do_kbinsertion:function(d,c){var b=c+'/../img/kb-eplace.gif"';return d.replace(/\[kitchenbug\-your\-recipe\-appears\-here\-([^\]]*)\]/g,function(f,e){var g='<img src="'+b+' class="kitchenbugRecipe mceItem" title="'+tinymce.DOM.encode(e).replace(/^\D+/g,"")+'" ';g=g+'style="border: 1px dashed #888; background-color: #f2f8ff; width: 99%; height: 150px;"/>';return g})},_do_postkbinsert:function(c){function b(d,e){e=new RegExp(e+'="([^"]+)"',"g").exec(d);return e?tinymce.DOM.decode(e[1]):""}return c.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(f,e){var d=b(e,"class");if(d.indexOf("kitchenbugRecipe")!=-1){return"<p>[kitchenbug-your-recipe-appears-here-"+tinymce.trim(b(e,"title"))+"]</p>"}return f})},_createkbButtons:function(){var b=tinymce.activeEditor,d=tinymce.DOM,e,c;if(d.get("kb_recipebtns")){return}d.add(document.body,"div",{id:"kb_recipebtns",style:"display:none;"});e=d.add("kb_recipebtns","img",{src:this.url+"/../img/SizeA.gif",id:"wp_kbeditrecipe",width:"24",height:"24",title:"Edit Recipe"});tinymce.dom.Event.bind(e,"mousedown",function(h){var f=tinymce.activeEditor;var g=tinymce.DOM;g.hide(g.select("#kb_recipebtns"));f.plugins.wordpress._hideButtons();f.execCommand("openkitchenbugeditor")});c=d.add("kb_recipebtns","img",{src:this.url+"/../img/deleteA.gif",id:"wp_kbdelrecipe",width:"24",height:"24",title:"Remove Recipe"});tinymce.dom.Event.bind(c,"mousedown",function(i){var f=tinymce.activeEditor,g=f.selection.getNode();if(g.nodeName=="IMG"&&f.dom.hasClass(g,"kitchenbugRecipe")){f.dom.remove(g);f.execCommand("mceRepaint");f.dom.events.cancel(i)}f.plugins.wordpress._hideButtons();var h=tinymce.DOM;h.hide(h.select("#kb_recipebtns"));kBugObject.recipeIds=null;kBugObject.isUpdating=false})},toggleDisplay:function(){origin=jQuery("#kb_form3").text();isLogged=jQuery("#kb_form3").data("login");jQuery(".kb-top-error-msg").hide();if(isLogged&&isLogged=="0"){jQuery("#kb_form").show();jQuery("#kb_form2").hide();return}if(origin&&origin=="add new"){jQuery("#kb_form").hide();jQuery("#kb_form2").show()}if(origin&&origin=="edit"){if(kBugObject.isUpdating==false){alert("Please save (post or draft) before editing the recipe");return false}else{jQuery("#kb_form").show();jQuery("#kb_form2").hide()}}jQuery(".ui-widget-content").show()},getInfo:function(){return{longname:"Kitchenbug",author:"Kitchenbug",authorurl:"http://www.kitchenbug.com",infourl:"http://www.kitchenbug.com",version:"0.6.0"}}});tinyMCE.PluginManager.add("kitchenbug",tinymce.plugins.Kitchenbug)})(jQuery);