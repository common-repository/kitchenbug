var NO_JQUERY={};(function(b,d,e){if(!("console" in b)){var f=b.console={};f.log=f.warn=f.error=f.debug=function(){}}if(d===NO_JQUERY){d={fn:{},extend:function(){var h=arguments[0];for(var j=1,g=arguments.length;j<g;j++){var c=arguments[j];for(var k in c){h[k]=c[k]}}return h}}}d.fn.pm=function(){console.log("usage: \nto send:    $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])");return this};d.pm=b.pm=function(c){a.send(c)};d.pm.bind=b.pm.bind=function(h,g,c,j){a.bind(h,g,c,j)};d.pm.unbind=b.pm.unbind=function(g,c){a.unbind(g,c)};d.pm.origin=b.pm.origin=null;d.pm.poll=b.pm.poll=200;var a={send:function(c){var j=d.extend({},a.defaults,c),g=j.target;if(!j.target){console.warn("postmessage target window required");return}if(!j.type){console.warn("postmessage type required");return}var h={data:j.data,type:j.type};if(j.success){h.callback=a._callback(j.success)}if(j.error){h.errback=a._callback(j.error)}if(("postMessage" in g)&&!j.hash){a._bind();g.postMessage(JSON.stringify(h),j.origin||"*")}else{a.hash._bind();a.hash.send(j,h)}},bind:function(k,j,g,m){if(("postMessage" in b)&&!m){a._bind()}else{a.hash._bind()}var c=a.data("listeners.postmessage");if(!c){c={};a.data("listeners.postmessage",c)}var h=c[k];if(!h){h=[];c[k]=h}h.push({fn:j,origin:g||d.pm.origin})},unbind:function(p,n){var h=a.data("listeners.postmessage");if(h){if(p){if(n){var k=h[p];if(k){var g=[];for(var j=0,c=k.length;j<c;j++){var q=k[j];if(q.fn!==n){g.push(q)}}h[p]=g}}else{delete h[p]}}else{for(var j in h){delete h[j]}}}},data:function(g,c){if(c===e){return a._data[g]}a._data[g]=c;return c},_data:{},_CHARS:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),_random:function(){var g=[];for(var c=0;c<32;c++){g[c]=a._CHARS[0|Math.random()*32]}return g.join("")},_callback:function(g){var c=a.data("callbacks.postmessage");if(!c){c={};a.data("callbacks.postmessage",c)}var h=a._random();c[h]=g;return h},_bind:function(){if(!a.data("listening.postmessage")){if(b.addEventListener){b.addEventListener("message",a._dispatch,false)}else{if(b.attachEvent){b.attachEvent("onmessage",a._dispatch)}}a.data("listening.postmessage",1)}},_dispatch:function(q){try{var h=JSON.parse(q.data)}catch(s){console.warn("postmessage data invalid json: ",s);return}if(!h){return}if(!h.type){console.warn("postmessage message type required");return}var n=a.data("callbacks.postmessage")||{},k=n[h.type];if(k){k(h.data)}else{var j=a.data("listeners.postmessage")||{};var u=j[h.type]||[];for(var m=0,p=u.length;m<p;m++){var g=u[m];if(g.origin&&g.origin!="*"&&q.origin!==g.origin){console.warn("postmessage message origin mismatch",q.origin,g.origin);if(h.errback){var t={message:"postmessage origin mismatch",origin:[q.origin,g.origin]};a.send({target:q.source,data:t,type:h.errback})}continue}try{var c=g.fn(h.data);if(h.callback){a.send({target:q.source,data:c,type:h.callback})}}catch(s){if(h.errback){a.send({target:q.source,data:s,type:h.errback})}}}}}};a.hash={send:function(r,c){var o=r.target,g=r.url;if(!g){console.warn("postmessage target window url is required");return}g=a.hash._url(g);var h,q=a.hash._url(b.location.href);if(b==o.parent){h="parent"}else{try{for(var j=0,l=parent.frames.length;j<l;j++){var k=parent.frames[j];if(k==b){h=j;break}}}catch(m){h=b.name}}if(h==null){console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list");return}var n={"x-requested-with":"postmessage",source:{name:h,url:q},postmessage:c};var p="#x-postmessage-id="+a._random();o.location=g+p+encodeURIComponent(JSON.stringify(n))},_regex:/^\#x\-postmessage\-id\=(\w{32})/,_regex_len:"#x-postmessage-id=".length+32,_bind:function(){if(!a.data("polling.postmessage")){setInterval(function(){var g=""+b.location.hash,c=a.hash._regex.exec(g);if(c){var h=c[1];if(a.hash._last!==h){a.hash._last=h;a.hash._dispatch(g.substring(a.hash._regex_len))}}},d.pm.poll||200);a.data("polling.postmessage",1)}},_dispatch:function(p){if(!p){return}try{p=JSON.parse(decodeURIComponent(p));if(!(p["x-requested-with"]==="postmessage"&&p.source&&p.source.name!=null&&p.source.url&&p.postmessage)){return}}catch(t){return}var h=p.postmessage,q=a.data("callbacks.postmessage")||{},k=q[h.type];if(k){k(h.data)}else{var m;if(p.source.name==="parent"){m=b.parent}else{m=b.frames[p.source.name]}var j=a.data("listeners.postmessage")||{};var w=j[h.type]||[];for(var n=0,s=w.length;n<s;n++){var g=w[n];if(g.origin){var v=/https?\:\/\/[^\/]*/.exec(p.source.url)[0];if(v!==g.origin){console.warn("postmessage message origin mismatch",v,g.origin);if(h.errback){var u={message:"postmessage origin mismatch",origin:[v,g.origin]};a.send({target:m,data:u,type:h.errback,hash:true,url:p.source.url})}continue}}try{var c=g.fn(h.data);if(h.callback){a.send({target:m,data:c,type:h.callback,hash:true,url:p.source.url})}}catch(t){if(h.errback){a.send({target:m,data:t,type:h.errback,hash:true,url:p.source.url})}}}}},_url:function(c){return(""+c).replace(/#.*$/,"")}};d.extend(a,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:false}})})(this,typeof jQuery==="undefined"?NO_JQUERY:jQuery);if(!("JSON" in window&&window.JSON)){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());(function(f){var e=(f.browser.msie?"paste":"input")+".mask";var d=(window.orientation!=undefined);f.mask={definitions:{"9":"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"};f.fn.extend({caret:function(a,c){if(this.length==0){return}if(typeof a=="number"){c=(typeof c=="number")?c:a;return this.each(function(){if(this.setSelectionRange){this.setSelectionRange(a,c)}else{if(this.createTextRange){var h=this.createTextRange();h.collapse(true);h.moveEnd("character",c);h.moveStart("character",a);h.select()}}})}else{if(this[0].setSelectionRange){a=this[0].selectionStart;c=this[0].selectionEnd}else{if(document.selection&&document.selection.createRange){var b=document.selection.createRange();a=0-b.duplicate().moveStart("character",-100000);c=a+b.text.length}}return{begin:a,end:c}}},unmask:function(){return this.trigger("unmask")},format:function(){var b=function a(c,m,k){c=c.toString();var l="";if(m>c.length){for(i=0;i<(m-c.length);i++){l+="0"}}return k?l.concat(c.toString()):l.concat(c.toString())};this[0].value=b(Math.floor(this[0].value/60),2,true)+":"+b(Math.round(this[0].value%60),2,false);jQuery(this).attr("last_value",this[0].value);return this},formatForPost:function(){var a=this[0].value.split(":");this[0].value=parseInt(a[0])*60+parseInt(a[1])},mask:function(o,b){if(!o&&this.length>0){var n=f(this[0]);return n.data(f.mask.dataName)()}b=f.extend({placeholder:"_",completed:null},b);var p=f.mask.definitions;var c=[];var a=o.length;var m=null;var q=o.length;f.each(o.split(""),function(g,h){if(h=="?"){q--;a=g}else{if(p[h]){c.push(new RegExp(p[h]));if(m==null){m=c.length-1}}else{c.push(null)}}});return this.trigger("unmask").each(function(){var B=f(this);var h=f.map(o.split(""),function(r,s){if(r!="?"){return p[r]?b.placeholder:r}});var z=B.val();function C(r){while(++r<=q&&!c[r]){}return r}function g(r){while(--r>=0&&!c[r]){}return r}function j(u,t){if(u<0){return}for(var r=u,s=C(t);r<q;r++){if(c[r]){if(s<q&&c[r].test(h[s])){h[r]=h[s];h[s]=b.placeholder}else{break}s=C(s)}}D();B.caret(Math.max(m,u))}function y(t){for(var r=t,v=b.placeholder;r<q;r++){if(c[r]){var u=C(r);var s=h[r];h[r]=v;if(u<q&&c[u].test(s)){v=s}else{break}}}}function E(v){var t=v.which;if(t==8||t==46||(d&&t==127)){var s=B.caret(),r=s.begin,u=s.end;if(u-r==0){r=t!=46?g(r):(u=C(r-1));u=t==46?C(u):u}l(r,u);j(r,u-1);return false}else{if(t==27){B.val(z);B.caret(0,k());return false}}}function A(w){var v=w.which,s=B.caret();if(w.ctrlKey||w.altKey||w.metaKey||v<32){return true}else{if(v){if(s.end-s.begin!=0){l(s.begin,s.end);j(s.begin,s.end-1)}var r=C(s.begin-1);if(r<q){var u=String.fromCharCode(v);if(c[r].test(u)){y(r);h[r]=u;D();var t=C(r);B.caret(t);if(b.completed&&t>=q){b.completed.call(B)}}}return false}}}function l(r,t){for(var s=r;s<t&&s<q;s++){if(c[s]){h[s]=b.placeholder}}}function D(){return B.val(h.join("")).val()}function k(u){var s=B.val();var t=-1;for(var w=0,v=0;w<q;w++){if(c[w]){h[w]=b.placeholder;while(v++<s.length){var r=s.charAt(v-1);if(c[w].test(r)){h[w]=r;t=w;break}}if(v>s.length){break}}else{if(h[w]==s.charAt(v)&&w!=a){v++;t=w}}}if(!u&&t+1<a){B.val("");l(0,q)}else{if(u||t+1>=a){D();if(!u){B.val(B.val().substring(0,t+1))}}}return(a?w:m)}B.data(f.mask.dataName,function(){return f.map(h,function(r,s){return c[s]&&r!=b.placeholder?r:null}).join("")});if(!B.attr("readonly")){B.one("unmask",function(){B.unbind(".mask").removeData(f.mask.dataName)}).bind("focus.mask",function(){z=B.val();var r=k();D();var s=function(){if(r==o.length){B.caret(0,r)}else{B.caret(r)}};(f.browser.msie?s:function(){setTimeout(s,0)})()}).bind("blur.mask",function(){k();if(B.val()!=z){B.change()}}).bind("keydown.mask",E).bind("keypress.mask",A).bind(e,function(){setTimeout(function(){B.caret(k(true))},0)})}k()})}})})(jQuery);var sendPostMsg=function(a){if(a.type=="FBPUBLISH"){pm({target:window.frames.kb_fb_iframe,type:"message1",data:a})}else{pm({target:window.frames.kb_iframe,type:"message1",data:a})}};var kbugmce,recipeView,recipeMoodel,isLoggedIN=false;function setInputAttrOrValue(a){jQuery('input[name^="recipe"],input[name^="viewOnly"],textarea[name^="recipe"]').each(function(c,d){switch(a){case"IMPORT":d.value=jQuery(this).attr("last_value");break;case"FLUSH":var b=jQuery(this).attr("leavedefault");if(typeof b==="undefined"||b===false){d.value=""}break;case"EXPORT":default:jQuery(this).attr("last_value",d.value);break}jQuery(this).val(d.value)});if("FLUSH"==a){kBugObject.recipeIds=null;kBugObject.isUpdating=false}}function forceContinue(b,d,a){b.setAction("saveTags");kBugObject.recipeIds=kBugObject.analyzed.id;b.setRecipeId(kBugObject.analyzed.id);var c=jQuery(".load-image-div");a.disablePreloader("tags",{suggestedTags:kBugObject.analyzed.tags,tagsDOM:c});jQuery("#kb_recipe_end").unbind("click").click(function(){jQuery(".kb-error-more-open").hide();jQuery(".kb-ingredients-error-details").hide();jQuery(".kb-ingredients-error").hide();jQuery(".kb-ingredients-input").removeClass("field-error");jQuery(".kb-ingredients-input").removeClass("field-warning");setInputAttrOrValue();a.enablePreloader("tags");var h=jQuery("#kb_upload_image");var g=jQuery('select[name="recipe[category]"]');var e=jQuery('select[name="recipe[cuisine]"]');b.setParam("category",g.val());b.setParam("cuisine",e.val());b.setParam("img_source",h.val());if(jQuery("#kb_nutrition_toggle").attr("checked")){b.setParam("nutritionOn","on")}else{b.setParam("nutritionOn","off")}var f=JSON.stringify(b.getRecipe());action=new Object();action.action="saveTags";action.recipe=f;action.post_id=b.getRecipe().recipe.post_id;jQuery.post(kBugObject.ajaxURL,action,function(k){if(tinyMCE.activeEditor.getContent().indexOf(kBugObject.editorPrefix)==-1){tinyMCE.activeEditor.execCommand("mceInsertContent",false,k);tinyMCE.activeEditor.undoManager.add();tinymce.activeEditor.setContent(tinymce.activeEditor.getContent())}var j=b.getRecipe();sendPostMsg({type:"TAGS",params:j.recipe});jQuery(this).unbind("click").unbind("keypress")})})}jQuery(window).load(function(){var a=jQuery("#kb_post_status").val();if(kBugObject.permalink==kBugObject.postURL||"publish"!=a||"undefined"==typeof kBugObject.recipeIds){return}action=new Object();action.action="kbUpdateSource";action.recipe=JSON.stringify({recipe:{source:kBugObject.permalink}});action.post_id=kBugObject.post_id;jQuery.post(kBugObject.ajaxURL,action)});jQuery(document).ready(function(){kBugObject.version=kb_settings.version;kBugObject.pluginURL=kb_settings.pluginURL;kBugObject.ajaxURL=kb_settings.ajaxURL;kBugObject.configURL=kb_settings.configURL;kBugObject.editorPrefix=kb_settings.editorPrefix;kBugObject.permalink=kb_settings.permalink;var e=jQuery("#kb_post_id");kBugObject.post_id=e.val();jQuery("#ingredients-tooltip").hover(function(){jQuery("#tooltip-bubble").fadeIn()},function(){jQuery("#tooltip-bubble").fadeOut()});jQuery(".kb-preview-image-hoverimage-delete").click(function(){jQuery("#kb_upload_image").val("");jQuery("#kb_editor-preview-image-img").trigger("change");jQuery(".kb-preview-image-hoverimage-open").hide();jQuery(".kb-preview-image-hoverimage-delete").hide()});jQuery("#kb_editor-preview-image-img").change(function(){if(jQuery("#kb_upload_image").val()===""){jQuery("#kb_editor-preview-image-img").attr("src",kBugObject.pluginURL+"/application/assets/img/NoImageYet.gif");kBugObject.imageSource=""}else{kBugObject.imageSource=jQuery("#kb_upload_image").val();jQuery("#kb_editor-preview-image-img").attr("src",jQuery("#kb_upload_image").val());jQuery("#mies1-img").attr("src",jQuery("#kb_upload_image").val())}});jQuery(".editor-preview-image").hover(function(){if(jQuery("#kb_upload_image").val()!=""){jQuery(".kb-preview-image-hoverimage-open").show();jQuery(".kb-preview-image-hoverimage-delete").show()}},function(){jQuery(".kb-preview-image-hoverimage-open").hide();jQuery(".kb-preview-image-hoverimage-delete").hide()});jQuery(".kb-preview-image-hoverimage-open").click(function(){jQuery("#upload_image_button").click()});jQuery("#kb-insert-recipe-button").click(function(){var z=jQuery("#recipelist option:selected").val();if(z.length==0){return}action=new Object();action.action="kbsaveRecipeInsert";action.recipe_id=z;action.post_id=kBugObject.post_id;jQuery.post(kBugObject.ajaxURL,action,function(A){if(tinyMCE.activeEditor.getContent().indexOf(kBugObject.editorPrefix)==-1){tinyMCE.activeEditor.execCommand("mceInsertContent",false,"[kitchenbug-your-recipe-appears-here-"+z+"]");tinyMCE.activeEditor.undoManager.add();tinymce.activeEditor.setContent(tinymce.activeEditor.getContent())}kBugObject.recipeIds=z;jQuery(".ui-widget-content").hide();jQuery(".ui-widget-overlay").fadeOut()})});jQuery("#kb-create-new-recipe-button").click(function(){jQuery("#kb_form").show();jQuery("#kb_form2").hide()});jQuery("#kb_iframe").attr("src",window.location.protocol+"//"+kBugObject.configURL+"/analyzer/index/wordpress?"+Math.ceil(Math.random()*50000));var a=0;var c=jQuery("#kb_container"),y={recipe:{}},b=0,h=jQuery("#kb_preloader"),w=h.find("span"),r=jQuery("#kb_submit"),x=jQuery("#kb_r_tips"),g=jQuery("#kb_image"),u=g.parent(),m=jQuery("#error_image"),f=jQuery("#kb_li_iframe"),q=jQuery("#kb_tips"),v=jQuery("#kb_general"),d=jQuery("#kb_tags"),n=jQuery("#kb_recipe_end"),t=jQuery("#kb_form");var o="ANALYZE";var k="FBPUBLISH";var p="174px";var j="FORCE_CONTINUE";setInputAttrOrValue();jQuery(".numbersOnly").keyup(function(){this.value=this.value.replace(/[^0-9\.]/g,"")});r.click(function(){if(b){b=0;return false}b=1;setInputAttrOrValue();recipeModel.init().setAction("validateRecipe");window.KBValidator.start();jQuery('input[name^="recipe"],textarea[name^="recipe"]').each(function(H,I){var F=jQuery(this);if("none"==F.parent().parent().parent().css("display")){return true}var G=I.name.replace("recipe[","").replace(/\]/,"");recipeModel.setParam(G,I.value);window.KBValidator.Validate(G,I.value)});if(!window.KBValidator.isValid()){b=0;return}recipeView.enablePreloader("general");b=0;var z=[],E=[],D=[];var B=recipeModel.getRecipe();for(var C in B.recipe){if(!isNaN(C)){continue}if(-1!=C.indexOf("ingredients")){z.push(B.recipe[C]);recipeModel.deleteParam(C);C--}else{if(-1!=C.indexOf("directions")){E.push(B.recipe[C]);recipeModel.deleteParam(C);C--}else{if(-1!=C.indexOf("section")){D.push(B.recipe[C]);recipeModel.deleteParam(C);C--}}}}var A=recipeModel.getRecipeId();if(!A){recipeModel.newrecipe=true}if(!A&&a>0){A=a}recipeModel.setParams({ingredients:z,directions:E,ing_section:D,img_source:g.attr("img_source"),source:kBugObject.permalink,post_id:kBugObject.post_id,id:A,recipe_id:A,plugin_version:kBugObject.version});B=recipeModel.getRecipe();sendPostMsg({type:o,params:B.recipe})});jQuery.fn.setCharacterCounter=function(z){this.html(z);if(z<0){this.addClass("kb-off-limit")}else{this.removeClass("kb-off-limit")}return this};jQuery.fn.getCharacterCounter=function(){return this.attr("counter-limit")};jQuery.fn.attachCounter=function(A){var B=this.attr("id");var z=jQuery(A);this.updateCounter(A);setInterval(function(){jQuery("#"+B).updateCounter(A);var C=jQuery(".kb-off-limit");if(C.length>0){r.attr("disabled","disabled")}else{r.removeAttr("disabled")}},100);return this};jQuery.fn.updateCounter=function(A){var z=jQuery(A);z.setCharacterCounter(z.getCharacterCounter()-this.val().length)};recipeDialog={_bindOpenDialog:function(){jQuery(window).bind("kitchenbugopen",function(A){if(-1==tinyMCE.get("content").getContent().indexOf(kBugObject.editorPrefix)){setInputAttrOrValue("FLUSH")}c.dialog("option","zIndex",200001);var z=jQuery("#recipe-name");if(z.val()==""){z.val(jQuery("#title").val())}z.attachCounter("#kb-name-character-counter");jQuery("#recipe-description").attachCounter("#kb-description-character-counter");c.dialog("open")})},_bindCloseDialog:function(){if(typeof(c.dialog)!="undefined"){c.dialog({autoOpen:false,width:765,modal:true,dialogClass:"wp-dialog",close:function(){aD=false;if(isLoggedIN){recipeView.disablePreloader("general")}tinymce.activeEditor.setContent(tinymce.activeEditor.getContent())}})}},init:function(){this._bindOpenDialog();this._bindCloseDialog()}};recipeDialog.init();recipeModel={_recipeId:null,_object:null,init:function(){this.flush();this.setRecipeId(kBugObject.recipeIds);return this},setParams:function(z){for(var A in z){this.setParam(A,z[A])}},setParam:function(A,B){if(B instanceof Array){this._object.recipe[A]={};for(var z=0;z<B.length;z++){this._object.recipe[A][z]=B[z]}return}this._object.recipe[A]=B},setAction:function(z){this._object.action=z;return this},getRecipe:function(){return this._object},getValue:function(z){try{return this_object.recipe[z]}catch(A){return false}},deleteParam:function(z){delete this._object[z];return this},setRecipeId:function(z){this._recipeId=z},getRecipeId:function(){return this._recipeId},flush:function(){this._object={recipe:{},action:null};this._recipeId=null}};recipeView={force_continue:false,consts:{UPLOAD_IMAGE_PATH:"/uploads/recipes/"},nonCommonElements:null,init:function(){this.force_continue=false;recipeView.resetIframe();this.nonCommonElements=c.find(".clmn,.last");jQuery("#kb_recipe_back").click(function(){recipeView.goBack()})},resetIframe:function(){f.find("iframe").css({height:"60px",width:"265px"})},showLoginMode:function(z){r.parent().hide();f.find("iframe").width("98%");f.find("iframe").height("95%");if("undefined"!=typeof z){f.find("iframe").height(z+"px");return}this._cleanViewModes();f.addClass("loginMode viewMode");f.find("iframe").removeClass("iframe_default").addClass("iframe_login");this.nonCommonElements.not(f).hide();t.addClass("fullWidthMode viewMode");jQuery("#kb_preloader").css({display:"none"});jQuery(".kb-login-frame").css({display:"block"})},showUploadMode:function(z){jQuery(".kb-login-frame").css({display:"none"});recipeView.resetIframe();r.parent().show();n.hide();jQuery("#kb_recipe_back").hide();jQuery("#kb_submit").attr("value","Continue");jQuery("#kb_recipe_force_continue").hide();this._cleanViewModes();this.nonCommonElements.show();f.removeAttr("style");f.find("iframe").removeClass("iframe_login").addClass("iframe_defult");t.addClass("uploadMode uploadModeForm colsWidthMode viewMode");d.hide()},showForceContinue:function(z,A){jQuery("#kb_recipe_force_continue").show();jQuery("#kb_submit").attr("value","Try Again");view=this;jQuery("#kb_recipe_force_continue").click(function(){view.enablePreloader("general");view.forceContinue();forceContinue(z,A,view);jQuery(".kb-top-error-msg").hide();jQuery(".kb-top-warning-msg").hide()});this.showErrorMoreMode()},showErrorMoreMode:function(){jQuery("a.kb-error-more-open").click(function(){jQuery("textarea.kb-ingredients-input").addClass("kb-no-error-bg");jQuery(".kb-ingredients-error-details").show();return false});jQuery("a.kb-error-close").click(function(){jQuery("textarea.kb-ingredients-input").removeClass("kb-no-error-bg");jQuery(".kb-ingredients-error-details").hide();return false})},forceContinue:function(){this.force_continue=true},goBack:function(){r.parent().show();jQuery(".elem_100").css({display:"none"});t.removeClass("colsWidthMode tagsMode viewMode");if(jQuery(".kb-ingredients-error").css("display")=="none"){jQuery(".kb-error-more-open").hide()}jQuery(".kb-ingredients-error-details").hide();this.nonCommonElements.show();d.hide()},showTagMode:function(z){this._cleanViewModes();t.addClass("colsWidthMode tagsMode viewMode");if(!recipeModel.newrecipe){jQuery("#kb_recipe_end").attr("value","Update Recipe")}n.show();jQuery("#kb_recipe_back").show();d.show();d.find(".clmn,.last").show();r.parent().hide();jQuery(".elem_100").css({display:"inline"});z.tagsDOM.focus();z.tagsDOM.unbind("keypress").keypress(function(A){s(A,"kb_recipe_end",this)})},enablePreloader:function(z){h.css({display:"block"});this.nonCommonElements.hide();this._cleanViewModes();t.addClass("fullWidthMode preloaderMode viewMode");switch(z){case"general":w.text("Analyzing ...");break;case"tags":default:w.text(((kBugObject.isUpdating)?"Updating recipe ...":"Saving recipe ..."));d.hide();break}},disablePreloader:function(z,B,A){h.css({display:"none"});switch(z){case"general":this.showUploadMode();break;case"ingredientsError":this.showUploadMode();this.showForceContinue(B,A);break;case"tags":default:this.showTagMode(B);break}},cleanKBErrors:function(){jQuery(".kb_error").hide().text("");return this},_cleanViewModes:function(){jQuery(".viewMode").each(function(){jQuery(this).removeClass("fullWidthMode preloaderMode viewMode loginMode uploadMode tagsMode colsWidthMode")})}};recipeView.init();pm.bind("message1",function(A){switch(A.type){case"RECIPE_ERROR":recipeView.disablePreloader("general");window.KBValidator.setErrors(A.params);recipeView.showErrorMoreMode();break;case"LOGIN":isLoggedIN=false;recipeView.showLoginMode(A.errors);jQuery("#kb_form3").data("login","0");break;case"LOGGED":isLoggedIN=true;jQuery("#kb_form3").data("login","1");recipeView.showUploadMode();sendPostMsg({type:"LOGGED"});if(!jQuery("#userId").val()){jQuery.post(kBugObject.ajaxURL,{settings:{userId:A.params},action:"updateUserId"})}break;case"IMAGE":if(jQuery.isEmptyObject(A)||!A.image){recipeView.hideImage(A);recipeModel.setParam("img_source","");return}recipeView.showImage(A);recipeModel.setParam("img_source",A.image);break;case"TAGGED":kBugObject.isUpdating=true;jQuery("#kb_container").dialog("close");break;case"ANALYZED":b=0;try{kBugObject.analyzed=JSON.parse(A.params)}catch(B){}if("undefined"!=typeof kBugObject.analyzed.notValid){window.KBValidator.start();for(var z in kBugObject.analyzed.notValid){window.KBValidator.Validate(kBugObject.analyzed.notValid[z].name,kBugObject.analyzed.notValid[z].value)}recipeView.disablePreloader("general");return}recipeErrors=false;if(kBugObject.analyzed.ingredient_errors.length>0){window.KBValidator.start();window.KBValidator.setErrors(kBugObject.analyzed.ingredient_errors);recipeErrors=true}recipeModel.setParams({analyzed:kBugObject.analyzed,calories:kBugObject.analyzed.calories,id:kBugObject.analyzed.id,recipe_id:kBugObject.analyzed.id});if(!recipeErrors){forceContinue(recipeModel,A,recipeView);break}else{a=kBugObject.analyzed.id;recipeView.disablePreloader("ingredientsError",recipeModel,A);break}}});var l={_consts:{MAX_MASK:"99:99",DEFUALT_MASK:"00:00"},_calc:function(C){var A=C.val().match(/_/g);var D=C.val().replace(/:/g,"");var z="";var B=A?A.length:0;for(i=0;i<D.length-B;i++){z+=D[i]}for(i=z.length;i<4;i++){z="0"+z}return z.substr(0,2)+":"+z.substr(2,2)},process:function(A){var z=this;jQuery('input[name="viewOnly['+A+']"]').format().mask(z._consts.MAX_MASK,{placeholder:"_",defaultValue:z._consts.DEFAULT_MASK}).keyup(function(){jQuery('input[name="recipe['+A+']"]').val(z._calc(jQuery(this))).formatForPost()}).unbind("blur").blur(function(){jQuery(this).val(z._calc(jQuery(this)))});return z}};l.process("prep_time").process("cook_time");var s=function(B,C,A){var z=(B.keyCode?B.keyCode:B.which);if(z==13){jQuery("#"+C).click();jQuery(A).blur()}};jQuery("input,select").keypress(function(z){s(z,"kb_submit",this)});window.KBValidator={_messages:{required:"Please enter a %name.","int":"%name can be a numeric value only",min:"%name size must be 1 or higher",upto:"%name size is limited to ",from:"%name size has to be at least ",generic:"The following issues exists: ",more:"Some ingredients were not analyzed. ",direct:"Please enter at least one cooking direction.",ingred:"Please enter at least one ingredient."},_rules:{name:["required"],prepTime:["required","int"],cookingTime:["required","int"],servings:["required","int",{upto:20},{from:1}],ingredients:["ingred"],directions:["direct"],dir_section:["required"],ing_section:["required"],generic:["generic"],more:["more"]},_fieldNames:{name:["Recipe Name"],prepTime:["Preparation Time"],cookingTime:["Cooking Time"],servings:["Servings"],ingredients:["Ingredients"],directions:["Directions"],dir_section:["required"],ing_section:["required"],generic:["generic"],more:["more"]},ERROR:2,WARNING:1,_errors:{},isValid:function(){if(jQuery.isEmptyObject(this._errors)){return true}return false},start:function(){this._flush()},tempName:"",Validate:function(B,E){this.tempName=B;if("undefined"==typeof this._rules[B]){B=B.substring(0,B.indexOf("["));if("undefined"==typeof this._rules[B]){return}}var A,D;for(var C=0;C<this._rules[B].length;C++){if(this._rules[B][C] instanceof Object){for(var z in this._rules[B][C]){A=z}D=this._rules[B][C][A]}else{A=this._rules[B][C]}switch(A){case"required":if(!E){this._setError(A,B)}break;case"direct":if(!E){this._setError(A,B)}break;case"ingred":if(!E){this._setError(A,B)}break;case"from":if(D>E){this._setError(A,B,{num:D})}break;case"upto":if(D<E){this._setError(A,B,{num:D})}break;case"min":if(D>E.length){this._setError(A,B,{num:D})}break;case"int":if(isNaN(E)){this._setError(A,B)}break;case"generic":this._messages.generic=E;this._setError(A,B);break;default:this._messages.generic=E;this._setError(A,B);break}if("undefined"!=typeof this._errors[this.tempName]){break}}this._appendError()},setErrors:function(A){this._flush();if(A instanceof Array){for(var z in A){if(A[z].tempName){this.tempName=A[z].tempName}else{this.tempName=A[z].name}if("undefined"!=typeof A[z].more){this._serErrorMore(A[z].rule,A[z].name,A[z].more)}else{this._setError(A[z].rule,A[z].name,A[z].args)}this._appendError()}}else{jQuery(".kb-top-error-msg-text").html(A.params.more);jQuery(".kb-top-error-msg").show()}},_serErrorMore:function(F,z,E){if("undefined"==typeof this._errors[this.tempName]){this._errors[this.tempName]=""}var A="";if("undefined"!=typeof E){if(E instanceof Object){for(var C in E){var G="";var B=0;for(var D in E[C].errors){G+=E[C].errors[D].message;B=E[C].errors[D].type;if(D<E[C].errors.length-1){G+=", "}}var H="";if(B=="error"){H=" kb-code-error"}else{if(B=="warning"){H=" kb-code-warning"}else{if(B=="notice"){H=" kb-code-notice"}}}A+='<li class="'+H+'">';A+='<span class="kb-ingredients-error-sentence">'+E[C].sentence+"</span>";A+='<span class="kb-ingredients-error-message">';A+=G;A+="</span>";A+="</li>"}}}if(A!=""){jQuery(".kb-error-more-open").show();this._errors[this.tempName]="Some ingredients were not identified.";jQuery("ul.kb-ingredient-errors-list").html(A)}else{jQuery(".kb-error-more-open").hide();this._errors[this.tempName]="";jQuery("ul.kb-ingredient-errors-list").html("")}},_setError:function(D,B,A){if("undefined"==typeof this._errors[this.tempName]){this._errors[this.tempName]=""}var z=this._fieldNames[B][0];var E=this._messages[D].replace("%name",z.toLowerCase());E=E.charAt(0).toUpperCase()+E.slice(1);if("undefined"!=typeof A){if(A instanceof Object){for(var C in A){E=E+A[C]+", "}E=E.substring(0,E.length-2)}else{E=E+A}}this._errors[this.tempName]+=E},_appendError:function(){var D=this._manipuleByName(this.tempName);var A=jQuery("#error_"+D.errorContainer);var C=jQuery("#recipe-"+D.errorContainer);if(this._errors[this.tempName]){A[D.type](this._errors[this.tempName]);if(C.hasClass("kb-ingredients-input")&&!(kBugObject.analyzed==null)&&kBugObject.analyzed.recipe_error==this.WARNING){C.addClass("field-warning")}else{C.addClass("field-error")}A.show()}else{A[D.type]("");C.removeClass("field-error");C.removeClass("field-warning");A.hide()}var B=jQuery(".field-warning").length;var z=jQuery(".field-error").length;if(B>0&&z==0){jQuery(".kb-top-error-msg").hide();jQuery(".kb-top-warning-msg").show()}else{if(z>0){jQuery(".kb-top-error-msg-text").html("Sorry, we could not process your recipe.");jQuery(".kb-top-error-msg").show();jQuery(".kb-top-warning-msg").hide()}else{jQuery(".kb-top-error-msg").hide();jQuery(".kb-top-warning-msg").hide()}}},_manipuleByName:function(A){var z={type:"html",errorContainer:A};if(-1!=A.indexOf("yield")){z.errorContainer="yield"}else{try{z.errorContainer=z.errorContainer.replace("[","\\[").replace("]","\\]")}catch(B){z.errorContainer="generic"}}return z},_flush:function(){for(var z in this._errors){this.tempName=z;this._errors[z]=null;this._appendError()}this._errors={}}}});